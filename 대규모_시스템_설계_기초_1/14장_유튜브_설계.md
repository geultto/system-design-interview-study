
유튜브에 대한 통계 자료
- MAU: 21억
- 매일 재생되는 비디오 수: 50억
- 5천만 명의 창작자
- 모바일 인터넷 트래픽 가운데 37%를 점유
- 2019년 기준 연간 광고 수입이 150억 달러
- 80개 언어로 이용 가능

## 1. 문제 이해 및 설계 범위 확정
- **핵심 기능**: 비디오 업로드/시청
- **지원 단말**: 모바일 앱, 웹 브라우저, 스마트 TV
- **DAU**: 500만 명
- **일일 비디오 업로드 수**: 50만 개
- **일일 비디오 시청 수** : 2500만 회
- **비디오 해상도**: 현존하는 대부분을 지원
- **비디오 평균 크기**: 300MB
- **암호화 필요**
- **다국어 지원**
- **클라우드 서비스 활용 가능**
- **빠른 비디오 업로드**
- **원활한 재생**
- **낮은 인프라 비용**
- **높은 가용성과 규모 확장성, 안정성**

#### 클라우드 비용 산정
아래는 클라우드(CDN)를 통해 비디오를 서비스할 때의 예상 비용이다.

- 매일 추가로 요구되는 저장 용량 = 50만 x 300MB = **150TB**
- CDN 비용 = 2500만 x 0.3GB x $0.02 = **$150,000**
	- 모든 트래픽이 미국에서 발생한다고 가정

위 비용을 줄일 수 있는 방안도 상세 설계에서 고민해보자.


---
## 2. 개략적 설계안 제시 및 동의 구하기
### 개략적 설계안

![img.png](https://blog.kakaocdn.net/dna/cw2coO/btsEnjsQrwL/AAAAAAAAAAAAAAAAAAAAAG5hE478Xn-V-IKJUKH4I2TnEVouifYa-wgG8wWV4Gv4/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1764514799&allow_ip=&allow_referer=&signature=uSQsDiU6kulqA4IqpUgpKyi7k58%3D)

- **단말(client)**: 컴퓨터, 폰, 스마트 TV 등을 통해 유튜브를 시청할 수 있다.
- **CDN**
    - 비디오는 CDN에 저장한다. 재생을 하면 CDN으로부터 스트리밍이 이루어진다.
    - 넷플릭스도 AWS를 사용하고 페이스북도 아카마이의 CDN을 사용한다.
- **API 서버** 
	- 비디오 스트리밍을 제외한 모든 요청은 API 서버가 처리한다. 
	- 피드 추천, 비디오 업로드 URL 생성, DB 및 캐시 갱신, 사용자 가입 등을 수행

### 비디오 업로드 절차
![img_1.png](https://blog.kakaocdn.net/dna/sRJdO/btsEnY23tKD/AAAAAAAAAAAAAAAAAAAAAFsTHP0V4yTD4Q-cW4TEtnze7YKK2PkCdF9T36DR98ap/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1764514799&allow_ip=&allow_referer=&signature=H%2B1%2FxqoANw%2BVAudRJmaKIarg6RQ%3D)

- **사용자**: 컴퓨터나 모바일 폰, 혹은 스마트 TV를 통해 유튜브를 시청하는 이용자
- **로드밸런서**: API 서버 각각으로 고르게 요청을 분산하는 역할
- **API 서버**: 비디오 스트리밍을 제외한 다른 모든 요청을 처리
- **메타데이터 데이터베이스**: 비디오의 메타데이터를 보관. 
	- 샤딩과 다중화 적용하여 성능 및 가용성 요구사항 충족
- **메타데이터 캐시**: 성능을 높이기 위해 비디오 메타데이터와 사용자 객체는 캐시
- **원본 저장소**: 원본 비디오를 보관할 대형 이진 파일 저장소(BLOB) 시스템
- **트랜스코딩 서버**: 비디오 인코딩이라 부르기도 하며, 비디오의 포맷(MPEG, HLS)등을 변환
- **트랜스코딩 비디오 저장소**: 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
- **CDN**: 비디오를 캐시. 사용자가 재생 버튼을 누르면 비디오 스트리밍은 CDN 통해 이루어짐
- **트랜스코딩 완료 큐**: 비디오 트랜스코딩 완료 이벤트들을 보관할 메시지 큐
- **트랜스코딩 완료 핸들러**: 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터 베이스를 갱신할 작업 서버들


==비디오 업로드는 다음의 두 프로세스가 병렬적으로 수행되며 이루어진다.==
##### 비디오 업로드
1. 비디오를 원본 저장소에 저장
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩을 수행
3. 트랜스코딩이 완료되면 아래 두 절차를 병렬로 수행
    1. 완료된 비디오를 트랜스코딩 저장소로 업로드하고, CDN에 올린다.
    2. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣고, 핸들러가 이를 처리한다.
4. API 서버가 단말에게 스트리밍 준비가 되었다고 알림

##### 메타데이터 갱신
- 원본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다.
- 이 요청에 포함된 메타데이터에는 파일 이름, 크기, 포맷 등의 정보가 들어 있다.
- API 서버는 이 정보로 메타데이터 DB와 캐시를 업데이트한다.

### 비디오 스트리밍 절차
비디오 스트리밍은 비교적 간단하며 CDN을 통해서 이루어진다.

![img_2.png](https://blog.kakaocdn.net/dna/BSlzj/btsEmFi4Tp1/AAAAAAAAAAAAAAAAAAAAANnU4hCLribeDu87ol84bBajxC2t6zlOxzw2JmrPQ-tb/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1764514799&allow_ip=&allow_referer=&signature=%2BJbJhmisKkg3x4qvzPn0DtA2KvE%3D)

- 스트리밍 프로토콜
	- MPEG-DASH
	- 애플 HLS
	- 마이크로소프트 스무드 스트리밍
	- 어도비 HTTP 동적 스트리밍
- 프로토콜마다 지원하는 비디오 인코딩과 플레이어가 다르다
- 사용자의 단말에 가장 가까운 CDN 에지 서버가 비디오 전송을 담당 → 전송지연은 아주 낮음

---
## 3. 상세 설계
### 3-1. 비디오 트랜스코딩
비디오가 **다른 단말에서도 순조롭게 재생**되려면, **호환 가능한 비트레이트와 포맷**로 저장되어야 한다.

> 비트 레이트는 단위 시간당 처리하거나 전송하는 비트(bit)의 양을 의미합니다. 주로 '초당 비트(bit/s, bps)' 단위로 표시하며, 영상이나 음성 파일에서는 품질과 용량에 직접적인 영향을 미치는 핵심 요소입니다. 비트 레이트가 높을수록 더 많은 정보가 담겨 품질이 좋아지지만, 파일 용량은 커집니다. 반대로 낮을수록 용량은 작아지지만 화질이나 음질은 떨어집니다.
 
비디오 트랜스코딩은 다음의 이유로 매우 중요하다.

- **저장 공간 효율성 확보**: 가공되지 않은 원본 비디오는 막대한 저장 공간을 차지하므로, 트랜스코딩을 통해 효율적으로 크기를 줄여야 한다.
    
- **단말 및 브라우저 호환성 해결**: 대다수의 단말 및 브라우저가 특정 비디오 포맷만 지원한다. 따라서 호환성 문제를 해결하기 위해 하나의 원본 비디오를 여러 포맷으로 인코딩해야 한다.
    
- **다양한 재생 환경 지원 (Adaptive Bitrate Streaming)**: 사용자의 네트워크 대역폭 및 인터넷 속도에 따라 끊김 없는 재생을 보장하기 위해, 360p, 720p, 1080p 등 다양한 해상도(화질)로 미리 인코딩해두어야 한다.

#### DAG
각기 다른 유형의 비디오 프로세싱 파이프라인을 지원하면서, 처리 과정의 병렬성을 높일 수 있어야 한다.
페이스북의 스트리밍 비디오 엔진은 이를 위해 **DAG(Directed Acyclic Graph)** 모델을 도입했다.

![img_3.png](https://blog.kakaocdn.net/dna/py602/btsEmEYOQNi/AAAAAAAAAAAAAAAAAAAAABrU1D_zdh0bNfrPboFlrGVWUfNzFALdvpdKWJe7zeZ1/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1764514799&allow_ip=&allow_referer=&signature=0TPM%2BwuRlGf0%2BAbuce4N35CTgSo%3D)

- 원본 비디오를 비디오/오디오/메타데이터로 나누어 처리한다.
- 비디오 부분에 적용되는 작업은 다음과 같다
	- 검사: 좋은 품질의 비디오인지, 손상은 없는지 확인
	- 인코딩: 다양한 해상도, 코덱, 비트레이드 조합으로 인코딩

#### 아키텍처
위 내용을 바탕으로 작성한 비디오 트랜스코딩의 아키텍처는 아래와 같다.

![img_5.png](https://blog.kakaocdn.net/dna/boKRXY/btsEnc1AOHG/AAAAAAAAAAAAAAAAAAAAAGpdtzgbfEqnVFqKPdqDbY4fdJQr-uJu9qA-oo1gjHLJ/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1764514799&allow_ip=&allow_referer=&signature=nVfbkKr6Q%2BhF6dlQb49SkHO8zfU%3D)

##### 전처리기
- 비디오 분할: GOP(Group of Pictures) 단위로 비디오를 쪼갠다.
- DAG 생성: 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG를 만든다.
- 데이터 캐시: GOP와 메타데이터를 임시 저장소에 저장한다.

##### DAG 스케줄러
DAG 그래프를 몇 개의 단계로 분할한 다음 각 작업을 자원 관리자의 작업 큐에 집어넣는다.

![img_6.png](https://blog.kakaocdn.net/dna/ZfATu/btsEmFclT32/AAAAAAAAAAAAAAAAAAAAAPLwCKqsUXFAYCL2Fa36pMDAz73Jt_J0TgtkCeac_8jU/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1764514799&allow_ip=&allow_referer=&signature=iNuqbG2OTW%2F8T9IOXPaKMSmjP4k%3D)

##### 자원 관리자
자원 배분을 효과적으로 수행한다.

![img_7.png](https://blog.kakaocdn.net/dna/bNnYIL/btsEmFJ9NAD/AAAAAAAAAAAAAAAAAAAAADtDQ8tMs_dQvblNMDt6nsayRLjzT3kXWSoC80VLw5he/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1764514799&allow_ip=&allow_referer=&signature=PT5DKwoSB2m30gIg43LlivJ4t2M%3D)

- **작업 큐**: 실행할 작업이 보관된 우선순위 큐
- **작업 서버 큐**: 작업 서버의 가용 상태 정보가 보관된 우선순위 큐이다.
- **실행 큐**: 현재 실행 중인 작업 및 작업 서버 정보가 보관되어 있는 큐이다.
- **작업 스케줄러**:
    - 최적의 작업/서버를 골라 해당 작업 서버가 작업을 수행하도록 지시한다.
    - 해당 작업이 어떤 서버에게 할당 되었는지에 관한 정보를 실행 큐에 넣는다.
    - 작업이 완료되면 해당 작업을 실행 큐에서 제거한다.

##### 작업 서버
작업 서버는 DAG에 정의된 작업을 수행한다. 작업 종류에 따라 작업 서버도 구분하여 관리한다.

![img_8.png](https://blog.kakaocdn.net/dna/bvcKNL/btsEmCUetwN/AAAAAAAAAAAAAAAAAAAAALPFyi6B2qJYLwg5e-Fu1kg2ctjKwjfHQUj6OoYwPhC-/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1764514799&allow_ip=&allow_referer=&signature=EhCmWXzOLCjpyBW6k54FqoBTWtE%3D)

##### 임시 저장소
임시 저장소로 어떤 시스템을 선택할 것이냐는 저장할 데이터의 특징에 따라 달라진다. 메타 데이터는 작업 서버가 빈번히 참조하기 때문에 메모리에 캐시해두면 좋을 것이다. 비디오/오디오 데이터는 BLOB 저장소에 두는 것이 바람직하다. 

임시 저장소에 보관한 데이터는 프로세싱이 끝나면 삭제한다.


### 3-2. 시스템 최적화
##### 속도 최적화: 비디오 병렬 업로드
비디오 전부를 한 번의 업로드로 올리는 것은 비효율적이다.

비디오는 작은 GOP들로 분할할 수 있다. 분할한 GOP를 병렬적으로 업로드하면 설사 일부가 실패해도 빠르게 업로드를 재개할 수 있으며 업로드 속도를 높일 수 있다.

##### 속도 최적화: 업로드 센터를 사용자 근거리에 지정
업로드 센터를 여러 곳에 두면 업로드 속도를 개선할 수 있다.

미국 거주자는 북미 지역 업로드 센터로, 중국 사용자는 아시아 센터로 보내도록 하는 것이다.
이를 위해서 본 설계안을 CDN을 업로드 센터로 이용한다.

##### 속도 최적화: 모든 절차를 병렬화
느슨하게 결합된 시스템은 Latency(응답 속도)를 줄이고 자원을 효율적으로 사용할 수 있다.

비디오를 원본 저장소에서 CDN으로 옮기기까지의 과정을 메시지 큐를 사용하면 결합도를 낮출 수 있다.

![img_9.png](https://blog.kakaocdn.net/dna/uC81o/btsEnXiLHf0/AAAAAAAAAAAAAAAAAAAAALXHnP2T3ZiR3oqFIMw-Ue-4qvCiwEENt7VAzHefxD6m/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1764514799&allow_ip=&allow_referer=&signature=Oq3dJ0g8hL6%2BPAcmpZxgCtYP9Rs%3D)

인코딩 모듈은 다운로드 모듈의 작업이 끝나기를 더 이상 기다릴 필요가 없다. 메시지 큐에 보관된 이벤트 각각을 인코딩 모듈은 병렬적으로 처리할 수 있다.

##### 안전성 최적화: 미리 사인된 업로드 URL
허가받은 사용자만이 올바른 장소에 비디오를 업로드할 수 있도록 하기 위해, 미리 사인된(pre-signed) 업로드 URL을 이용한다.

##### 안전성 최적화: 비디오 보호
비디오의 저작권을 보호하기 위해, 다음 세 가지 선택지 가운데 하나를 채택할 수 있다.

- DRM 시스템 도입
- AES 암호화
- 워터마크

##### 비용 최적화
CDN(Content Delivery Network) 비용을 최적화하기 위해 다음과 같은 전략을 고려할 수 있다.

- 인기 비디오는 CDN을 통해 재생하되 다른 비디오는 비디오 서버를 통해 재생한다.
- 인기가 별로 없는 짧은 비디오라면 필요할 때 인코딩하여 재생할 수 있다.
- 특정 지역에서만 인기가 높은 비디오는 해당 지역의 CDN 서버에만 저장한다.
- CDN을 직접 구축하고 ISP와 제휴한다.

위와 같은 최적화는 콘텐츠 인기도, 이용 패턴, 비디오 크기 등의 데이터에 근거한 것이다. 최적화를 시도하기 전에 시청 패턴을 분석하는 것은 중요하다.

## 3-3. 오류 처리
대형 시스템에서 오류 발생은 불가피하며, 이를 **회복 가능(Recoverable) 오류**와 **회복 불가능(Unrecoverable) 오류** 두 종류로 나누어 처리한다.

회복 가능 오류는 특정 작업이 실패했을 때 **몇 번의 재시도**로 해결될 수 있다. 만약 재시도 후에도 계속 실패한다면 클라이언트에게 **적절한 오류 코드**를 반환해야 한다. 

반면, 회복 불가능 오류(예: 비디오 포맷 불량)는 해당 작업을 **즉시 중단**하고 클라이언트에게 적절한 오류 코드를 반환해야 한다.


---
## 4. 마무리
아래와 같이 면접관과 추가로 더 논의할 수 있는 부분이 있다.

- API 계층의 규모 확장성 확보 방안   
    - 무상태 서버이므로 수평적 규모 확장이 가능

- 데이터 베이스 계층의 규모 확장성 확보 방안 
    - 데이터베이스의 다중화와 샤딩 방법에 대해 논의 

- 라이브 스트리밍 (live streaming) 
    - 응답지연이 낮아야 한다. → 스트리밍 프로토콜 선정에 유의 
    - 병렬화 필요성은 떨어지고 작은 단위의 데이터를 실시간으로 빨리 처리해야 한다.
    - 너무 많은 시간이 소요되는 오류 처리 방안은 사용이 어렵다.

- 비디오 삭제 
    - 저작권을 위반한 비디오, 선정적 비디오 등의 부적절한 비디오는 내려야 한다.




참고: [분산 시스템 설계 - 유튜브 설계해보기!](https://jaehoney.tistory.com/380)
